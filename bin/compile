#!/bin/sh

indent() {
  sed -u 's/^/       /'
}

BUILD_DIR=$1
CACHE_DIR=$2

# Clear previous cache dir
rm -rf "$CACHE_DIR/perl-deps"
VENDOR_DEPS="$BUILD_DIR/local"
CACHE_DEPS="$CACHE_DIR/local"

PERL_VERSION="5.14.2"
PERL_PACKAGE="perloku.s3.amazonaws.com/perl-$PERL_VERSION.tgz"

VENDORED_PERL="$BUILD_DIR/vendor/perl"

echo "-----> Vendoring Perl"

mkdir -p $VENDORED_PERL  && curl $PERL_PACKAGE -s -o -  | tar xzf - -C $VENDORED_PERL

# Set up so we can use Perl right away
export PATH="$VENDORED_PERL/bin:$CACHE_DIR/local/bin:$PATH"
export PERL5LIB="$VENDORED_PERL/lib/$PERL_VERSION:$VENDORED_PERL/lib/site_perl/$PERL_VERSION"
export PERL5OPT="-Mlocal::lib=$CACHE_DIR/local"

echo "Using Perl $PERL_VERSION" | indent

CPANM="perl -S cpanm --notest -l $CACHE_DEPS"

if [ -f $BUILD_DIR/app.psgi ]; then
  echo "-----> Installing Starman for PSGI"
  $CPANM Starman 2>&1 | indent
fi

if [ -f $BUILD_DIR/carton.lock ]; then
  echo "-----> Installing Carton"
  $CPANM carton 2>&1 | indent
fi

echo "-----> Installing dependencies"

if [ -f $BUILD_DIR/carton.lock ]; then
  # Wrap cpanm as shell script which invokes the correct perl interpreter
  # We need this for carton
  mkdir -p /tmp/cpanm-bin
  echo "perl -S $(which cpanm) \"\$@\"" > /tmp/cpanm-bin/cpanm
  chmod +x /tmp/cpanm-bin/cpanm
  export PATH="/tmp/cpanm-bin:$PATH"

  perl -S carton install --path "$CACHE_DEPS" 2>&1 | indent
else
  $CPANM --installdeps .
fi

cp -R "$CACHE_DEPS" "$VENDOR_DEPS"
echo "Dependencies installed" | indent

